<!DOCTYPE html>
<html>
    <head>
        <title>
            The Onion Scrape
        </title>
        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js">
        </script>
        <!-- Materialize -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css" rel="stylesheet"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js">
        </script>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
            <style>
                .thumb-elem {
    			max-height: 100%;
    			max-width: 100%;
    		}
    		.title-row, .desc-row {
    			margin-bottom: 0px;
    		}
    		.container .article-row {
    			margin-right: 10px;
    		}
    		#articles {
    		  display: inline-block;
    		  overflow: auto;
    		  overflow-x: hidden;
    		  width: 65%;
    		  height: 550px;
    		}
    		#comments {
    		  float: right;
    		  width: 30%;
    		}
			.comment-btn {
				margin: auto;
			}
            </style>
        </link>
    </head>
    <body>
        <div class="main">
            <div class="container">
                <div class="row">
                    <h1>
                        The Onion Scrape
                    </h1>
                </div>
                <div id="articles">
                </div>
                <div id="comments">
                </div>
            </div>
        </div>
    </body>
</html>
<script>
    $(document).ready(function() {
		$.getJSON("/articles", function(data) {
			for (var i = 0; i < data.length; i++) {
				
				var thumbnail = $('<img/>', {
					class: 'thumb-elem',
					src: data[i].thumb
				});
				var title = $('<h5/>', {
					class: 'title-elem',
					text: data[i].title
				});
				var description = $('<p/>', {
					class: 'desc-element',
					text: data[i].desc
				});
				var link = $('<a/>', {
					class: 'link-elem',
					href: data[i].link
				});
				var col1 = $('<div/>', {
					class: 'col s12 m4 l3'
				});
				var col2 = $('<div/>', {
					class: 'col s12 m8 l9'
				});
				var row_title = $('<div/>', {
					class: 'row title-row'
				});
				var row_desc = $('<div/>', {
					class: 'row desc-row'
				});
				var row_article = $('<div/>', {
					class: 'row article-row'
				});
				var comment_button = '<button class="btn-floating waves-effect waves-light red comment-btn" data-id=' + data[i]._id + '><i class="material-icons">add</i></button>';
				
				link.append(title);
				row_title.append(link);
				row_desc.append(description);
				col2.append(row_title);
				col2.append(row_desc);
				col1.append(thumbnail);
				col1.append(comment_button);
				row_article.append(col1);
				row_article.append(col2);
				

				$("#articles").append(row_article);
			}
		});

		$(document).on('click', 'button', function() {
			var thisId = $(this).attr("data-id");
			$('#comments').empty();
 			console.log(thisId);
 			$.ajax({
 			  method: "GET",
 			  url: "/article/" + thisId
 			}).done(function(data) {
 				console.log(data.comment);
 				// Add new comment form
 				var new_comment_row = $('<div/>', {
					class: 'row new-comment-row'
				});
				var new_title = $('<input/>', {
					id: 'titleinput',
					name: 'title',
					placeholder: 'Title'
				});
				var new_body = $('<textarea/>', {
					id: 'bodyinput',
					name: 'body',
					placeholder: 'Text'
				});
				var new_button = $('<a/>', {
					class: 'waves-effect waves-light red btn',
					id: 'submit-new',
					'data-id': data._id,
					text: 'Add Comment'
				});
				new_comment_row.append(new_title);
				new_comment_row.append(new_body);
				new_comment_row.append(new_button);
				$('#comments').append(new_comment_row);

				// Display existing comments
 				for (var i = 0; i < data.length; i++) {
 					var row_comment = $('<div/>', {
 						class: 'row comment-row'
 					});
 					var col1 = $('<div/>', {
 						class: 'col s12 m10 l11'
 					});
 					var title_row = $('<div/>', {
 						class: 'row'
 					});
 					var title = $('<p/>', {
 						class: 'comment-title-elem',
 						text: data.comment[i].title
 					});
 					var body_row = $('<div/>', {
 						class: 'row'
 					});
 					var body = $('<p/>', {
 						class: 'comment-body-elem',
 						text: data.comment[i].body
 					});
 					var col2 = $('<div/>', {
 						class: 'col s12 m2 l1'
 					}); 
 					var delete_btn = '<a class="waves-effect waves-light red btn" data-id=' + data.comment[i]._id + '>Delete Comment</a>';
 					title_row.append(title);
 					body_row.append(body);
 					col1.append(title_row);
 					col1.append(body_row);
 					row_comment.append(col1);
 					col2.append(delete_btn);
 					row_comment.append(col2);
 					$('#comments').append(row_comment);
 				}
 			});
 			
		});
		
		$(document).on('click', '#submit-new', function() {
			var thisId = $(this).attr("data-id");

			// Run a POST request to change the note, using what's entered in the inputs
			$.ajax({
				method: "POST",
				url: "/article/" + thisId,
				data: {
			    	title: $("#titleinput").val(),
			    	body: $("#bodyinput").val()
			  	}
			}).done(function(data) {
				console.log(data);
			    $("#comments").empty();
			});
		});
		
	});
</script>
